content_for :title, _("Order") + " | " + @user
content_for :lending_section, "active"

#edit-contract-view.wrapper.margin-top-m
  = render :partial => 'manage/tabs/lending', :locals => {:active_tab => :orders}

  .row.content-wrapper.min-height-xl.min-width-full.straight-top
    .margin-top-l.padding-horizontal-m
      .row
        .col2of6
          %h1.headline-l= _("Edit") + " " + _("Order")
          %h2.headline-s.light
            = render partial: "manage/users/tooltip", locals: {user: @user}
          - if dg_user = @order.delegated_user
            %h2.headline-s.light= "(#{dg_user})"

        #daily-navigation.col4of6.text-align-right= render :partial => "manage/orders/edit/navigation"

    .margin-top-m.padding-inset-m.separated-bottom
      = render :partial => "manage/orders/edit/purpose"

    #status.padding-horizontal-m.margin-top-m
      .emboss.blue.padding-inset-s
        %p.paragraph-s
          %img.margin-right-s.max-width-micro{:src => asset_path("loading.gif")}
          %strong
            = _("Loading availability")

    .row.margin-top-s.padding-top-m.padding-horizontal-m
      .col2of3
        = render :partial => "manage/orders/edit/add"

      .col1of3
        .float-right= render :partial => "manage/orders/edit/selection"

    #lines.padding-inset-m= render :partial => "manage/reservations/grouped_lines", :locals => {:grouped_lines => @grouped_lines, :line_partial => "manage/reservations/order"}

  :coffeescript
    createRecord = (json, recordType) ->
      for record in JSON.parse(json)
        recordType.addRecord new recordType(record)

    jQuery ->
      userJson = `#{j @user.to_json(methods: :image_url, except: :extended_info)}`
      orderJson = `#{j @order.to_json(include: :delegated_user)}`
      modelsJson = `#{j @models.to_json}`
      softwareJson = `#{j @software.to_json}`
      itemsJson = `#{j @items.to_json}`
      reservationsJson = `#{j @reservations.to_json}`

      App.User.addRecord new App.User($.extend({groupIds: #{@group_ids}}, JSON.parse(userJson)))
      App.Order.addRecord new App.Order(JSON.parse(orderJson))

      createRecord(modelsJson, App.Model)
      createRecord(softwareJson, App.Software)
      createRecord(itemsJson, App.Item)
      createRecord(reservationsJson, App.Reservation)

      App.Order.current = App.Order || {}
      entitlementGroupIdsJson = `#{json_escape(Order.find(id_param).user.entitlement_group_ids.to_json)}`
      App.Order.entitlement_group_ids = JSON.parse(entitlementGroupIdsJson)

      new App.OrdersEditController
        el: "#edit-contract-view"
        order: App.Order.find("#{@order.id}")